<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äºŒæ‰‹æ©Ÿå›æ”¶åƒ¹ - {% if type %}{{ type }}{% else %}å¾Œå°ç®¡ç†{% endif %}</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
            padding-bottom: 100px;
            /* LINE Browser Fix */
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .nav-link {
            padding: 10px 20px;
            text-decoration: none;
            color: #555;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            font-weight: bold;
        }

        .nav-link.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .brand-filters {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .brand-btn {
            padding: 5px 10px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            cursor: pointer;
            border-radius: 4px;
            text-decoration: none;
            color: #333;
            font-size: 0.9em;
        }

        .brand-btn:hover,
        .brand-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .action-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #007bff;
            color: white;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        .price {
            color: #333;
            font-weight: bold;
        }

        .diff-up {
            color: green;
            font-size: 0.9em;
            margin-left: 8px;
        }

        .diff-down {
            color: red;
            font-size: 0.9em;
            margin-left: 8px;
        }

        .final-price-input {
            width: 80px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-weight: bold;
            color: #007bff;
        }

        /* Mobile RWD */
        input {
            font-size: 16px !important;

            /* iOS Zoom Fix */
            /* é‡å°å ±åƒ¹å–®é é¢ */
                {
                % if is_static_quote %
            }

            text-align: right;

                {
                % endif %
            }
        }

        /* éš±è—ç®¡ç†åŠŸèƒ½å€ */
            {
            % if is_static_quote %
        }

        .controls,
        .deduction-input,
        .save-btn {
            display: none !important;
        }

            {
            % endif %
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
                padding-bottom: 120px;
            }

            .container {
                padding: 10px;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .action-group {
                justify-content: space-between;
            }

            /* Hide less important columns on mobile */
            th:nth-child(1),
            td:nth-child(1) {
                /* Brand */
                display: none;
            }

            th,
            td {
                padding: 8px 4px;
                font-size: 14px;
            }

            .final-price-input {
                width: 70px;
            }

            .deduction-input {
                width: 40px !important;
            }

            .save-btn {
                font-size: 1.5em !important;
                padding: 10px !important;
                /* Larger touch target */
                width: 44px;
                height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>äºŒæ‰‹æ©Ÿå›æ”¶åƒ¹å ±åƒ¹ç³»çµ±</h1>

        <!-- ä¿®æ­£ BuildError: é€£çµåˆ°æ ¹è·¯ç”±ï¼Œä¸¦ä½¿ç”¨ GET åƒæ•¸æ§åˆ¶é ç±¤ -->
        <div class="nav-tabs">
            <a href="{{ url_for('index', type='iPhone') }}"
                class="nav-link {% if type == 'iPhone' or not type %}active{% endif %}">iPhone</a>
            <a href="{{ url_for('index', type='Android') }}"
                class="nav-link {% if type == 'Android' %}active{% endif %}">Android</a>
        </div>

        <div class="controls">
            <!-- ç¢ºä¿åªæœ‰åœ¨ç®¡ç†å“¡æ¨¡å¼ä¸‹æ‰é¡¯ç¤ºæ§åˆ¶é … -->
            {% if is_admin %}
            <div class="action-group">
                <label for="global-deduction">ä¸€éµæ‰£%ï¼š</label>
                <input type="number" id="global-deduction" placeholder="%" style="width: 60px; padding: 5px;"
                    autocomplete="off">
            </div>

            <div class="action-group">
                <input type="text" id="quote-name" placeholder="å ±åƒ¹å–®åç¨± / æŒ‡ä»¤" style="padding: 5px;" autocomplete="off">
                <button onclick="handleCommand()" style="padding: 5px 10px; cursor: pointer;">åŸ·è¡Œ</button>
            </div>
            {% endif %}

            {% if type == 'Android' %}
            <!-- é€™è£¡éœ€è¦ Android çš„ç¯©é¸é‚è¼¯ï¼Œä½†ç›®å‰ app.py ç¼ºä¹ç²å– brands çš„é‚è¼¯ -->
            <!-- æš«æ™‚éš±è—æˆ–ä½¿ç”¨ placeholder é‚è¼¯ -->
            {% endif %}
        </div>

        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>å» ç‰Œ</th>
                        <th>å‹è™Ÿ</th>
                        <th>å®¹é‡</th>
                        <th>å›æ”¶åƒ¹</th>

                        {% if is_admin %}
                        <th>æŠ˜æ‰£ (%)</th>
                        <th>è©¦ç®—åƒ¹æ ¼ (å¯æ‰‹å‹•)</th>
                        <th>æ“ä½œ</th>
                        {% else %}
                        <th>æœ€çµ‚å ±åƒ¹</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    <!-- æ ¹æ“š type æˆ– is_static_quote æ±ºå®šé¡¯ç¤ºå“ªå€‹æ•¸æ“š -->
                    {% set display_data = iphone_data if type == 'iPhone' or is_static_quote and iphone_data is defined
                    else android_data %}

                    {% for item in display_data %}
                    <tr class="data-row" data-brand="{{ item.brand or 'Apple' }}" data-model="{{ item.model }}"
                        data-capacity="{{ item.capacity }}">
                        <td>{{ item.brand or 'Apple' }}</td>
                        <td>{{ item.model }}</td>
                        <td>{{ item.capacity }}</td>
                        <td class="price" data-price="{{ item.max_price }}">
                            <!-- å¦‚æœæ˜¯å ±åƒ¹å–®é é¢ï¼Œç›´æ¥é¡¯ç¤ºæœ€çµ‚åƒ¹æ ¼ -->
                            {% if is_static_quote %}
                            {{ item.final_price or item.price }}
                            {% else %}
                            <!-- ç®¡ç†é é¢é¡¯ç¤ºåŸå§‹åƒ¹æ ¼ -->
                            {{ item.max_price }}
                            {% if item.diff and item.diff > 0 %}
                            <span class="diff-up">â–²+{{ item.diff }}</span>
                            {% elif item.diff and item.diff < 0 %} <span class="diff-down">â–¼{{ item.diff }}</span>
                                {% endif %}
                                {% endif %}
                        </td>

                        {% if is_admin %}
                        <!-- ç®¡ç†å“¡æ“ä½œå€ -->
                        <td>
                            <input type="number" min="0" max="100" class="deduction-input"
                                style="width: 60px; padding: 5px;" placeholder="%" autocomplete="off">
                        </td>
                        <td>
                            <input type="text" class="final-price-input"
                                value="{{ item.manual_price if item.manual_price else item.price if item.price else item.final_price if item.final_price else '-' }}"
                                autocomplete="off">
                        </td>
                        <td>
                            <button class="save-btn" onclick="savePrice(this)"
                                style="cursor: pointer; border: none; background: none; font-size: 1.2em;"
                                title="ä¿å­˜åƒ¹æ ¼">ğŸ’¾</button>
                        </td>
                        {% elif is_static_quote %}
                        <!-- éœæ…‹å ±åƒ¹å–®æœ€çµ‚åƒ¹æ ¼ -->
                        <td>
                            {{ item.final_price or item.price }}
                        </td>
                        {% endif %}

                    </tr>
                    {% endfor %}
                </tbody>

                // ç¢ºä¿æ•¸å­—æ˜¯ 100 çš„å€æ•¸ï¼Œä¸”ç™¾ä½æ•¸æ˜¯ 0, 5, 7 çš„é‚è¼¯
                const roundOptions = [0, 500, 700];
                const base = Math.floor(price / 1000) * 1000;

                let bestPrice = 0;
                let minDiff = Infinity;

                for (let i = -1; i <= 1; i++) { // æª¢æŸ¥ç•¶å‰åƒä½æ•¸ã€å‰ä¸€å€‹åƒä½æ•¸å’Œä¸‹ä¸€å€‹åƒä½æ•¸ const currentBase=base + (i * 1000); for (const
                    option of roundOptions) { const candidate=currentBase + option; if (candidate < 0) continue; const
                    diff=Math.abs(price - candidate); if (diff < minDiff) { minDiff=diff; bestPrice=candidate; } else if
                    (diff===minDiff) { // å¹³æ‰‹æ™‚ï¼Œé¸æ“‡è¼ƒå¤§å€¼ï¼ˆç¢ºä¿æ¨å…¥æ–¹å‘æ˜¯å‘ä¸Šï¼‰ bestPrice=Math.max(bestPrice, candidate); } } } return
                    bestPrice; } // Function to calculate price for a row function calculateRow(input) { const
                    row=input.closest('tr'); const priceCell=row.querySelector('.price'); const
                    finalPriceInput=row.querySelector('.final-price-input'); if (!priceCell || !finalPriceInput) return;
                    // Get raw price string let priceStr=priceCell.getAttribute('data-price'); if (!priceStr)
                    priceStr=priceCell.innerText.split('â–²')[0].split('â–¼')[0].trim(); // Parse price to number const
                    maxPrice=parseInt(priceStr.replace(/[$, ]/g, '' ).trim()); // Get deduction percentage let
                    deduction=parseFloat(input.value); if (isNaN(deduction) || deduction < 0) deduction=0; if
                    (deduction> 100) deduction = 100;

                    // Calculate final price
                    if (!isNaN(maxPrice)) {
                    const rawFinal = maxPrice * (1 - deduction / 100);
                    const roundedFinal = customRound(rawFinal);

                    // æ ¼å¼åŒ–é¡¯ç¤ºï¼Œä¸¦å°‡è² æ•¸/é›¶é¡¯ç¤ºç‚º $0
                    finalPriceInput.value = roundedFinal <= 0 ? '$0' : '$' + roundedFinal.toLocaleString(); } else {
                        finalPriceInput.value='-' ; } } // Listen for individual inputs inputs.forEach(input=> {
                        input.addEventListener('input', function () {
                        calculateRow(this);
                        });
                        // åˆæ¬¡è¼‰å…¥æ™‚æ ¹æ“šåˆå§‹æŠ˜æ‰£è¨ˆç®—ä¸€æ¬¡
                        if (input.value) {
                        calculateRow(input);
                        }
                        });

                        // Listen for global input
                        if (globalInput) {
                        globalInput.addEventListener('input', function () {
                        const globalValue = this.value;
                        inputs.forEach(input => {
                        input.value = globalValue;
                        calculateRow(input);
                        });
                        });
                        }
                        }
                        });

                        // å„²å­˜å–®ä¸€åƒ¹æ ¼
                        function savePrice(btn) {
                        const row = btn.closest('tr');
                        const quoteNameInput = document.getElementById('quote-name');

                        if (!quoteNameInput || !quoteNameInput.value.startsWith('æ–°å¢/')) {
                        alert('è«‹å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥æ¡†è¼¸å…¥ "æ–°å¢/å ±åƒ¹å–®åç¨±" æŒ‡ä»¤ï¼');
                        return;
                        }

                        const clientName = quoteNameInput.value.substring(3).trim(); // æå–åç¨±

                        const brand = row.getAttribute('data-brand');
                        const model = row.getAttribute('data-model');
                        const capacity = row.getAttribute('data-capacity');
                        const finalPriceInput = row.querySelector('.final-price-input');
                        const price = finalPriceInput.value;

                        fetch('/update_single_price', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                        client_name: clientName, // ä½¿ç”¨ client_name è€Œä¸æ˜¯ quote_name
                        item: {
                        brand: brand,
                        model: model,
                        capacity: capacity,
                        price: price // åƒ¹æ ¼å¯èƒ½åŒ…å« '$' å’Œ ','ï¼Œå¾Œç«¯æœƒè™•ç†
                        }
                        })
                        })
                        .then(res => res.json())
                        .then(data => {
                        if (data.success) {
                        const link = data.link ? `<a href="${data.link}" target="_blank">é»æ“ŠæŸ¥çœ‹å ±åƒ¹å–®</a>` : 'ä¿å­˜æˆåŠŸ';
                        alert(`å–®ç­†ä¿å­˜æˆåŠŸï¼${link}`);
                        // Visual feedback
                        const originalText = btn.innerText;
                        btn.innerText = 'âœ…';
                        setTimeout(() => btn.innerText = originalText, 2000);
                        } else {
                        alert('ä¿å­˜å¤±æ•—: ' + (data.message || 'æœªçŸ¥éŒ¯èª¤'));
                        }
                        });
                        }

                        // è™•ç†æŒ‡ä»¤ (æŸ¥è©¢/æ–°å¢/åˆªé™¤/admin)
                        function handleCommand() {
                        const command = document.getElementById('quote-name').value.trim();
                        if (!command) return;

                        // 1. éš±è—å¾Œå°æŒ‡ä»¤ (admintim)
                        if (command === 'admintim') {
                        // ç”±æ–¼æ‚¨è¦æ–°å¢ /admin_dashboard è·¯ç”±ï¼Œé€™è£¡å‰ç«¯ç›´æ¥é‡å°å‘
                        window.location.href = '/admin_dashboard';
                        return;
                        }

                        const rows = document.querySelectorAll('.data-row');
                        const items = [];

                        // æå–æ‰€æœ‰åƒ¹æ ¼æ•¸æ“š
                        rows.forEach(row => {
                        const finalPriceInput = row.querySelector('.final-price-input');
                        const price = finalPriceInput.value;

                        // å¿…é ˆæœ‰åƒ¹æ ¼ï¼Œä¸”åƒ¹æ ¼ä¸æ˜¯åˆå§‹ç‹€æ…‹ '-'
                        if (price && price !== '-') {
                        items.push({
                        brand: row.getAttribute('data-brand'),
                        model: row.getAttribute('data-model'),
                        capacity: row.getAttribute('data-capacity'),
                        price: price // ä½¿ç”¨ priceï¼Œèˆ‡å¾Œç«¯ update_single_price ä¿æŒä¸€è‡´
                        });
                        }
                        });

                        // 2. åˆªé™¤æŒ‡ä»¤ (åˆªé™¤/åç¨±)
                        if (command.startsWith('åˆªé™¤/')) {
                        const clientName = command.substring(3).trim();
                        // æé†’ï¼šalert() æ‡‰æ”¹ç‚ºè‡ªå®šç¾© modal UIï¼Œä½†é€™è£¡æš«ç”¨ alert ä¿æŒåŠŸèƒ½
                        if (!confirm(`ç¢ºå®šè¦åˆªé™¤å ±åƒ¹å–®ï¼š${clientName} å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼`)) return;

                        // å‘¼å«å¾Œç«¯åˆªé™¤ API (å‡è¨­ç‚º /delete_quoteï¼Œé€™æ˜¯æœªä¾†è¦å¯¦ç¾çš„)
                        fetch('/delete_quote', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ client_name: clientName })
                        })
                        .then(res => res.json())
                        .then(data => {
                        alert(data.message || 'åˆªé™¤å¤±æ•—');
                        });
                        return;
                        }

                        // 3. æ–°å¢/æ›´æ–°æŒ‡ä»¤ (æ–°å¢/åç¨±)
                        if (command.startsWith('æ–°å¢/')) {
                        const clientName = command.substring(3).trim();

                        fetch('/generate_quote', {
                        method: 'POST',
                        headers: {
                        'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                        client_name: clientName, // ä½¿ç”¨ client_name
                        items: items // å‚³éå®Œæ•´çš„æ•¸æ“šåˆ—è¡¨
                        }),
                        })
                        .then(response => response.json())
                        .then(data => {
                        if (data.success) {
                        alert(`å ±åƒ¹å–® [${data.original_name}] å·²æ›´æ–°ï¼`);
                        window.open(data.link, '_blank'); // æ‰“é–‹çŸ­ç¶²å€
                        } else {
                        alert('ç”Ÿæˆ/æ›´æ–°å¤±æ•—: ' + (data.message || 'æœªçŸ¥éŒ¯èª¤'));
                        }
                        });
                        return;
                        }

                        // 4. æŸ¥è©¢æŒ‡ä»¤ (ç´”åç¨±)
                        const clientName = command;
                        fetch('/check_quote_exists', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: clientName })
                        })
                        .then(res => res.json())
                        .then(data => {
                        if (data.exists) {
                        alert(`å ±åƒ¹å–® [${clientName}] å­˜åœ¨ï¼`);
                        window.open(data.link, '_blank'); // æ‰“é–‹çŸ­ç¶²å€
                        } else {
                        alert(`å ±åƒ¹å–® [${clientName}] ä¸å­˜åœ¨ã€‚è«‹ä½¿ç”¨ "æ–°å¢/${clientName}" å»ºç«‹ã€‚`);
                        }
                        });
                        }
                        </script>
</body>

</html>