<div class="container">
    {% if is_static_quote and quote_client_name %}
    <h1>{{ quote_client_name }} å ±åƒ¹å–®</h1>
    {% else %}
    <h1>äºŒæ‰‹æ©Ÿå›æ”¶åƒ¹å ±åƒ¹ç³»çµ±</h1>
    {% endif %}

    {% if not is_static_quote %}
    <div class="nav-tabs">
        <a href="{{ url_for('index', type='iPhone') }}"
            class="nav-link {% if type == 'iPhone' or not type %}active{% endif %}">iPhone</a>
        <a href="{{ url_for('index', type='Android') }}"
            class="nav-link {% if type == 'Android' %}active{% endif %}">Android</a>
    </div>
    {% elif is_static_quote and iphone_data and android_data %}
    <div class="nav-tabs">
        <button onclick="switchStaticTab('iPhone')" class="nav-link active" id="tab-iphone">iPhone</button>
        <button onclick="switchStaticTab('Android')" class="nav-link" id="tab-android">Android</button>
    </div>
    {% endif %}

    <div class="controls">
        {% if is_admin %}
        <div class="action-group">
            <label for="global-deduction">ä¸€éµæ‰£%:</label>
            <input type="number" id="global-deduction" placeholder="%" style="width: 60px; padding: 5px;"
                autocomplete="off">
        </div>

        <div class="action-group">
            <input type="text" id="quote-name" placeholder="å ±åƒ¹å–®åç¨± / æŒ‡ä»¤" style="padding: 5px;" autocomplete="off">
            <button onclick="handleCommand()" style="padding: 5px 10px; cursor: pointer;">åŸ·è¡Œ</button>
        </div>
        {% endif %}
    </div>

    {% if is_static_quote %}
    <div class="quote-actions">
        <button onclick="generatePDF()" class="action-btn pdf-btn">ğŸ“„ ç”ŸæˆPDF</button>
        <button onclick="shareToLine()" class="action-btn line-btn">ğŸ’¬ å‚³é€åˆ°LINE</button>
    </div>
    <div id="generation-date" style="display: none;"></div>
    {% endif %}

    {% if type == 'Android' and is_admin and not is_static_quote %}
    <div class="brand-filters">
        <button class="brand-btn" onclick="loadBrandData('Samsung')">Samsung</button>
        <button class="brand-btn" onclick="loadBrandData('OPPO')">OPPO</button>
        <button class="brand-btn" onclick="loadBrandData('Sony')">Sony</button>
        <button class="brand-btn" onclick="loadBrandData('ASUS')">ASUS</button>
        <button class="brand-btn" onclick="loadBrandData('HTC')">HTC</button>
        <button class="brand-btn" onclick="loadBrandData('Xiaomi')">Xiaomi</button>
        <button class="brand-btn" onclick="loadBrandData('Realme')">Realme</button>
        <button class="brand-btn" onclick="loadBrandData('Vivo')">Vivo</button>
        <button class="brand-btn" onclick="loadBrandData('Google')">Google</button>
    </div>
    <div id="loading-indicator" style="display: none;">æ­£åœ¨è¼‰å…¥è³‡æ–™...</div>
    {% endif %}

    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    {% if not is_static_quote %}
                    <th>å» ç‰Œ</th>
                    {% endif %}
                    <th>å‹è™Ÿ</th>
                    <th>å®¹é‡</th>
                    <th>å›æ”¶åƒ¹</th>

                    {% if is_admin %}
                    <th>æŠ˜æ‰£ (%)</th>
                    <th>è©¦ç®—åƒ¹æ ¼ (å¯æ‰‹å‹•)</th>
                    <th>æ“ä½œ</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody id="data-table-body">
                {% if is_static_quote %}
                {% set show_iphone = iphone_data|length > 0 %}
                {% set show_android = android_data|length > 0 and not show_iphone %}

                {% for item in iphone_data %}
                <tr class="data-row type-iphone" {% if not show_iphone %}style="display: none;" {% endif %}
                    data-brand="{{ item.brand or 'Apple' }}" data-model="{{ item.model }}"
                    data-capacity="{{ item.capacity }}" data-price="{{ item.price }}">
                    <td>{{ item.model }}</td>
                    <td>{{ item.capacity }}</td>
                    <td class="price" data-price="{{ item.price }}">
                        {{ item.price }}
                    </td>
                </tr>
                {% endfor %}

                {% for item in android_data %}
                <tr class="data-row type-android" {% if not show_android %}style="display: none;" {% endif %}
                    data-brand="{{ item.brand }}" data-model="{{ item.model }}" data-capacity="{{ item.capacity }}"
                    data-price="{{ item.price }}">
                    <td>{{ item.model }}</td>
                    <td>{{ item.capacity }}</td>
                    <td class="price" data-price="{{ item.price }}">
                        {{ item.price }}
                    </td>
                </tr>
                {% endfor %}

                {% else %}
                {% set display_data = iphone_data if type == 'iPhone' or not type else android_data %}
                {% for item in display_data %}
                <tr class="data-row" data-brand="{{ item.brand or 'Apple' }}" data-model="{{ item.model }}"
                    data-capacity="{{ item.capacity }}">
                    {% if not is_static_quote %}
                    <td>{{ item.brand or 'Apple' }}</td>
                    {% endif %}
                    <td>{{ item.model }}</td>
                    <td>{{ item.capacity }}</td>
                    <td class="price" data-price="{{ item.max_price }}">
                        {{ item.max_price }}
                        {% if item.diff and item.diff > 0 %}
                        <span class="diff-up">â–²+{{ item.diff }}</span>
                        {% elif item.diff and item.diff < 0 %} <span class="diff-down">â–¼{{ item.diff }}</span>
                            {% endif %}
                    </td>

                    {% if is_admin %}
                    <td>
                        <input type="number" min="0" max="100" class="deduction-input"
                            style="width: 60px; padding: 5px;" placeholder="%" autocomplete="off">
                    </td>
                    <td>
                        <input type="text" class="final-price-input"
                            value="{{ item.default_price if item.default_price else item.manual_price if item.manual_price else item.price if item.price else item.final_price if item.final_price else '-' }}"
                            autocomplete="off">
                    </td>
                    <td>
                        <button class="save-btn" onclick="savePrice(this)"
                            style="cursor: pointer; border: none; background: none; font-size: 1.2em;"
                            title="ä¿å­˜åƒ¹æ ¼">ğŸ’¾</button>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<script>
    let currentBrand = null;

    document.addEventListener('DOMContentLoaded', function () {
        initializeCalculations();
    });

    function switchStaticTab(type) {
        // Update tabs
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        const tab = document.getElementById('tab-' + type.toLowerCase());
        if (tab) tab.classList.add('active');

        // Update rows
        document.querySelectorAll('.type-iphone').forEach(el => el.style.display = type === 'iPhone' ? '' : 'none');
        document.querySelectorAll('.type-android').forEach(el => el.style.display = type === 'Android' ? '' : 'none');
    }

    function initializeCalculations() {
        const inputs = document.querySelectorAll('.deduction-input');
        const globalInput = document.getElementById('global-deduction');

        function customRound(price) {
            const roundOptions = [0, 500, 700];
            const base = Math.floor(price / 1000) * 1000;
            let bestPrice = 0;
            let minDiff = Infinity;

            for (let i = -1; i <= 1; i++) {
                const currentBase = base + (i * 1000);
                for (const option of roundOptions) {
                    const candidate = currentBase + option;
                    if (candidate < 0) continue;
                    const diff = Math.abs(price - candidate);
                    if (diff < minDiff) {
                        minDiff = diff;
                        bestPrice = candidate;
                    } else if (diff === minDiff) {
                        bestPrice = Math.max(bestPrice, candidate);
                    }
                }
            }
            return bestPrice;
        }

        function calculateRow(input) {
            const row = input.closest('tr');
            const priceCell = row.querySelector('.price');
            const finalPriceInput = row.querySelector('.final-price-input');
            if (!priceCell || !finalPriceInput) return;

            let priceStr = priceCell.getAttribute('data-price');
            if (!priceStr) priceStr = priceCell.innerText.split('â–²')[0].split('â–¼')[0].trim();

            const maxPrice = parseInt(priceStr.replace(/[$, ]/g, '').trim());
            let deduction = parseFloat(input.value);
            if (isNaN(deduction) || deduction < 0) deduction = 0;
            if (deduction > 100) deduction = 100;

            if (!isNaN(maxPrice)) {
                const rawFinal = maxPrice * (1 - deduction / 100);
                const roundedFinal = customRound(rawFinal);
                finalPriceInput.value = roundedFinal <= 0 ? '$0' : '$' + roundedFinal.toLocaleString();
            } else {
                finalPriceInput.value = '-';
            }
        }

        inputs.forEach(input => {
            input.addEventListener('input', function () {
                calculateRow(this);
            });
        });

        if (globalInput) {
            globalInput.addEventListener('input', function () {
                const globalValue = this.value;
                const deductionInputs = document.querySelectorAll('.deduction-input');
                deductionInputs.forEach(input => {
                    input.value = globalValue;
                    calculateRow(input);
                });
            });
        }
    }

    function loadBrandData(brand) {
        currentBrand = brand;
        const loading = document.getElementById('loading-indicator');
        const tbody = document.getElementById('data-table-body');
        const buttons = document.querySelectorAll('.brand-btn');

        // æ›´æ–°æŒ‰éˆ•æ¨£å¼
        buttons.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        loading.style.display = 'block';
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">è¼‰å…¥ä¸­...</td></tr>';

        fetch(`/api/get_brand_data/${brand}`)
            .then(res => res.json())
            .then(result => {
                loading.style.display = 'none';
                if (result.success) {
                    renderBrandData(result.data, brand);
                } else {
                    tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: red;">è¼‰å…¥å¤±æ•—: ${result.message}</td></tr>`;
                }
            })
            .catch(err => {
                loading.style.display = 'none';
                tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: red;">è¼‰å…¥éŒ¯èª¤: ${err.message}</td></tr>`;
            });
    }

    function renderBrandData(data, brand) {
        const tbody = document.getElementById('data-table-body');
        tbody.innerHTML = '';

        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">ç„¡è³‡æ–™</td></tr>';
            return;
        }

        data.forEach(item => {
            const row = document.createElement('tr');
            row.className = 'data-row';
            row.setAttribute('data-brand', brand);
            row.setAttribute('data-model', item.model);
            row.setAttribute('data-capacity', item.capacity);

            const defaultPrice = item.default_price || '-';

            row.innerHTML = `
                    <td>${brand}</td>
                    <td>${item.model}</td>
                    <td>${item.capacity}</td>
                    <td class="price" data-price="${item.max_price}">${item.max_price}</td>
                    <td>
                        <input type="number" min="0" max="100" class="deduction-input"
                            style="width: 60px; padding: 5px;" placeholder="%" autocomplete="off">
                    </td>
                    <td>
                        <input type="text" class="final-price-input" value="${defaultPrice}" autocomplete="off">
                    </td>
                    <td>
                        <button class="save-btn" onclick="savePrice(this)"
                            style="cursor: pointer; border: none; background: none; font-size: 1.2em;"
                            title="ä¿å­˜åƒ¹æ ¼">ğŸ’¾</button>
                    </td>
                `;
            tbody.appendChild(row);
        });

        initializeCalculations();
    }

    function savePrice(btn) {
        const row = btn.closest('tr');
        const quoteNameInput = document.getElementById('quote-name');

        if (!quoteNameInput || !quoteNameInput.value.startsWith('æ–°å¢/')) {
            alert('è«‹å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥æ¡†è¼¸å…¥ "æ–°å¢/å ±åƒ¹å–®åç¨±" æŒ‡ä»¤ï¼');
            return;
        }

        const clientName = quoteNameInput.value.substring(3).trim();
        const brand = row.getAttribute('data-brand');
        const model = row.getAttribute('data-model');
        const capacity = row.getAttribute('data-capacity');
        const finalPriceInput = row.querySelector('.final-price-input');
        const price = finalPriceInput.value;

        fetch('/update_single_price', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                client_name: clientName,
                item: {
                    brand: brand,
                    model: model,
                    capacity: capacity,
                    price: price
                }
            })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('å–®ç­†ä¿å­˜æˆåŠŸï¼');
                    const originalText = btn.innerText;
                    btn.innerText = 'âœ…';
                    setTimeout(() => btn.innerText = originalText, 2000);
                } else {
                    alert('ä¿å­˜å¤±æ•—: ' + (data.message || 'æœªçŸ¥éŒ¯èª¤'));
                }
            });
    }

    function handleCommand() {
        const command = document.getElementById('quote-name').value.trim();
        if (!command) return;

        if (command === 'admintim') {
            // Fetch admin path from backend
            fetch('/get_admin_path')
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = `/${data.admin_path}`;
                    } else {
                        alert('Failed to get admin path: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(err => {
                    alert('Error: ' + err.message);
                });
            return;
        }

        const rows = document.querySelectorAll('.data-row');
        const items = [];

        rows.forEach(row => {
            const finalPriceInput = row.querySelector('.final-price-input');
            const price = finalPriceInput.value;

            if (price && price !== '-') {
                items.push({
                    brand: row.getAttribute('data-brand'),
                    model: row.getAttribute('data-model'),
                    capacity: row.getAttribute('data-capacity'),
                    price: price
                });
            }
        });

        if (command.startsWith('åˆªé™¤/')) {
            const clientName = command.substring(3).trim();
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤å ±åƒ¹å–®:${clientName} å—?æ­¤æ“ä½œä¸å¯é€†!`)) return;

            fetch('/delete_quote', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ client_name: clientName })
            })
                .then(res => res.json())
                .then(data => {
                    alert(data.message || 'åˆªé™¤å¤±æ•—');
                });
            return;
        }

        if (command.startsWith('æ–°å¢/')) {
            const clientName = command.substring(3).trim();

            fetch('/generate_quote', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    client_name: clientName,
                    items: items
                }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`å ±åƒ¹å–® [${data.original_name}] å·²æ›´æ–°!`);
                        window.open(data.link, '_blank');
                    } else {
                        alert('ç”Ÿæˆ/æ›´æ–°å¤±æ•—: ' + (data.message || 'æœªçŸ¥éŒ¯èª¤'));
                    }
                });
            return;
        }

        const clientName = command;
        fetch('/check_quote_exists', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: clientName })
        })
            .then(res => res.json())
            .then(data => {
                if (data.exists) {
                    alert(`å ±åƒ¹å–® [${clientName}] å­˜åœ¨!`);
                    window.open(data.link, '_blank');
                } else {
                    alert(`å ±åƒ¹å–® [${clientName}] ä¸å­˜åœ¨ã€‚è«‹ä½¿ç”¨ "æ–°å¢/${clientName}" å»ºç«‹ã€‚`);
                }
            });
    }

    function generatePDF() {
        const dateDiv = document.getElementById('generation-date');
        const now = new Date();
        const dateStr = now.toLocaleDateString('zh-TW', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });

        dateDiv.innerHTML = '<div class="generation-date-display">ç”Ÿæˆæ—¥æœŸï¼š' + dateStr + '</div>';
        dateDiv.style.display = 'block';

        const element = document.querySelector('.container');
        const opt = {
            margin: 10,
            filename: 'å ±åƒ¹å–®_' + document.querySelector('h1').textContent + '_' + now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0') + '.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).save().then(function () {
            setTimeout(function () {
                dateDiv.style.display = 'none';
            }, 1000);
        });
    }

    function shareToLine() {
        const currentUrl = window.location.href;
        const clientName = document.querySelector('h1').textContent;
        const message = clientName + '\n' + currentUrl;
        const lineUrl = 'https://line.me/R/msg/text/?' + encodeURIComponent(message);
        window.open(lineUrl, '_blank');
    }
</script>
</body>

</html>