<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‰∫åÊâãÊ©üÂõûÊî∂ÂÉπ - {% if type %}{{ type }}{% else %}ÂæåÂè∞ÁÆ°ÁêÜ{% endif %}</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
            padding-bottom: 100px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .nav-link {
            padding: 10px 20px;
            text-decoration: none;
            color: #555;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            font-weight: bold;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
        }

        .nav-link.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .action-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .brand-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 10px 0;
        }

        .brand-btn {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .brand-btn:hover {
            background: #0056b3;
        }

        .brand-btn.active {
            background: #28a745;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #007bff;
            color: white;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        .price {
            color: #333;
            font-weight: bold;
        }

        .diff-up {
            color: green;
            font-size: 0.9em;
            margin-left: 8px;
        }

        .diff-down {
            color: red;
            font-size: 0.9em;
            margin-left: 8px;
        }

        .final-price-input {
            width: 80px;
            padding: 5px;
        }

        .deduction-input {
            width: 60px;
        }

        .save-btn {
            font-size: 1.2em;
            cursor: pointer;
            border: none;
            background: none;
        }

        #loading-indicator {
            text-align: center;
            padding: 20px;
            font-size: 1.1em;
            color: #007bff;
        }

        .quote-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .action-btn {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .pdf-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .pdf-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .line-btn {
            background: linear-gradient(135deg, #06c755 0%, #00b900 100%);
            color: white;
        }

        .line-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(6, 199, 85, 0.3);
        }

        .generation-date-display {
            text-align: center;
            margin: 10px 0;
            font-size: 14px;
            color: #666;
        }

        @media print {
            .quote-actions {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        {% if is_static_quote and quote_client_name %}
        <h1>{{ quote_client_name }} Â†±ÂÉπÂñÆ</h1>
        {% else %}
        <h1>‰∫åÊâãÊ©üÂõûÊî∂ÂÉπÂ†±ÂÉπÁ≥ªÁµ±</h1>
        {% endif %}

        {% if not is_static_quote %}
        <div class="nav-tabs">
            <a href="{{ url_for('index', type='iPhone') }}"
                class="nav-link {% if type == 'iPhone' or not type %}active{% endif %}">iPhone</a>
            <a href="{{ url_for('index', type='Android') }}"
                class="nav-link {% if type == 'Android' %}active{% endif %}">Android</a>
        </div>
        {% elif is_static_quote and iphone_data and android_data %}
        <div class="nav-tabs">
            <button onclick="switchStaticTab('iPhone')" class="nav-link active" id="tab-iphone">iPhone</button>
            <button onclick="switchStaticTab('Android')" class="nav-link" id="tab-android">Android</button>
        </div>
        {% endif %}

        <div class="controls">
            {% if is_admin %}
            <div class="action-group">
                <label for="global-deduction">‰∏ÄÈçµÊâ£%:</label>
                <input type="number" id="global-deduction" placeholder="%" style="width: 60px; padding: 5px;"
                    autocomplete="off">
            </div>

            <div class="action-group">
                <input type="text" id="quote-name" placeholder="Â†±ÂÉπÂñÆÂêçÁ®± / Êåá‰ª§" style="padding: 5px;" autocomplete="off">
                <button onclick="handleCommand()" style="padding: 5px 10px; cursor: pointer;">Âü∑Ë°å</button>
            </div>
            {% endif %}
        </div>

        {% if is_static_quote %}
        <div class="quote-actions">
            <button onclick="generatePDF()" class="action-btn pdf-btn">üìÑ ÁîüÊàêPDF</button>
            <button onclick="shareToLine()" class="action-btn line-btn">üí¨ ÂÇ≥ÈÄÅÂà∞LINE</button>
        </div>
        <div id="generation-date" style="display: none;"></div>
        {% endif %}

        {% if type == 'Android' and is_admin and not is_static_quote %}
        <div class="brand-filters">
            <button class="brand-btn" onclick="loadBrandData('Samsung')">Samsung</button>
            <button class="brand-btn" onclick="loadBrandData('OPPO')">OPPO</button>
            <button class="brand-btn" onclick="loadBrandData('Sony')">Sony</button>
            <button class="brand-btn" onclick="loadBrandData('ASUS')">ASUS</button>
            <button class="brand-btn" onclick="loadBrandData('HTC')">HTC</button>
            <button class="brand-btn" onclick="loadBrandData('Xiaomi')">Xiaomi</button>
            <button class="brand-btn" onclick="loadBrandData('Realme')">Realme</button>
            <button class="brand-btn" onclick="loadBrandData('Vivo')">Vivo</button>
            <button class="brand-btn" onclick="loadBrandData('Google')">Google</button>
        </div>
        <div id="loading-indicator" style="display: none;">Ê≠£Âú®ËºâÂÖ•Ë≥áÊñô...</div>
        {% endif %}

        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        {% if not is_static_quote %}
                        <th>Âª†Áâå</th>
                        {% endif %}
                        <th>ÂûãËôü</th>
                        <th>ÂÆπÈáè</th>
                        <th>ÂõûÊî∂ÂÉπ</th>

                        {% if is_admin %}
                        <th>ÊäòÊâ£ (%)</th>
                        <th>Ë©¶ÁÆóÂÉπÊ†º (ÂèØÊâãÂãï)</th>
                        <th>Êìç‰Ωú</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody id="data-table-body">
                    {% if is_static_quote %}
                    {% set show_iphone = iphone_data|length > 0 %}
                    {% set show_android = android_data|length > 0 and not show_iphone %}

                    {% for item in iphone_data %}
                    <tr class="data-row type-iphone" {% if not show_iphone %}style="display: none;" {% endif %}
                        data-brand="{{ item.brand or 'Apple' }}" data-model="{{ item.model }}"
                        data-capacity="{{ item.capacity }}" data-price="{{ item.price }}">
                        <td>{{ item.model }}</td>
                        <td>{{ item.capacity }}</td>
                        <td class="price" data-price="{{ item.price }}">
                            {{ item.price }}
                        </td>
                    </tr>
                    {% endfor %}

                    {% for item in android_data %}
                    <tr class="data-row type-android" {% if not show_android %}style="display: none;" {% endif %}
                        data-brand="{{ item.brand }}" data-model="{{ item.model }}" data-capacity="{{ item.capacity }}"
                        data-price="{{ item.price }}">
                        <td>{{ item.model }}</td>
                        <td>{{ item.capacity }}</td>
                        <td class="price" data-price="{{ item.price }}">
                            {{ item.price }}
                        </td>
                    </tr>
                    {% endfor %}

                    {% else %}
                    {% set display_data = iphone_data if type == 'iPhone' or not type else android_data %}
                    {% for item in display_data %}
                    <tr class="data-row" data-brand="{{ item.brand or 'Apple' }}" data-model="{{ item.model }}"
                        data-capacity="{{ item.capacity }}">
                        {% if not is_static_quote %}
                        <td>{{ item.brand or 'Apple' }}</td>
                        {% endif %}
                        <td>{{ item.model }}</td>
                        <td>{{ item.capacity }}</td>
                        <td class="price" data-price="{{ item.max_price }}">
                            {{ item.max_price }}
                            {% if item.diff and item.diff > 0 %}
                            <span class="diff-up">‚ñ≤+{{ item.diff }}</span>
                            {% elif item.diff and item.diff < 0 %} <span class="diff-down">‚ñº{{ item.diff }}</span>
                                {% endif %}
                        </td>

                        {% if is_admin %}
                        <td>
                            <input type="number" min="0" max="100" class="deduction-input"
                                style="width: 60px; padding: 5px;" placeholder="%" autocomplete="off">
                        </td>
                        <td>
                            <input type="text" class="final-price-input"
                                value="{{ item.default_price if item.default_price else item.manual_price if item.manual_price else item.price if item.price else item.final_price if item.final_price else '-' }}"
                                autocomplete="off">
                        </td>
                        <td>
                            <button class="save-btn" onclick="savePrice(this)"
                                style="cursor: pointer; border: none; background: none; font-size: 1.2em;"
                                title="‰øùÂ≠òÂÉπÊ†º">üíæ</button>
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let currentBrand = null;

        document.addEventListener('DOMContentLoaded', function () {
            initializeCalculations();
        });

        function switchStaticTab(type) {
            // Update tabs
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            const tab = document.getElementById('tab-' + type.toLowerCase());
            if (tab) tab.classList.add('active');

            // Update rows
            document.querySelectorAll('.type-iphone').forEach(el => el.style.display = type === 'iPhone' ? '' : 'none');
            document.querySelectorAll('.type-android').forEach(el => el.style.display = type === 'Android' ? '' : 'none');
        }

        function initializeCalculations() {
            const inputs = document.querySelectorAll('.deduction-input');
            const globalInput = document.getElementById('global-deduction');

            function customRound(price) {
                const roundOptions = [0, 500, 700];
                const base = Math.floor(price / 1000) * 1000;
                let bestPrice = 0;
                let minDiff = Infinity;

                for (let i = -1; i <= 1; i++) {
                    const currentBase = base + (i * 1000);
                    for (const option of roundOptions) {
                        const candidate = currentBase + option;
                        if (candidate < 0) continue;
                        const diff = Math.abs(price - candidate);
                        if (diff < minDiff) {
                            minDiff = diff;
                            bestPrice = candidate;
                        } else if (diff === minDiff) {
                            bestPrice = Math.max(bestPrice, candidate);
                        }
                    }
                }
                return bestPrice;
            }

            function calculateRow(input) {
                const row = input.closest('tr');
                const priceCell = row.querySelector('.price');
                const finalPriceInput = row.querySelector('.final-price-input');
                if (!priceCell || !finalPriceInput) return;

                let priceStr = priceCell.getAttribute('data-price');
                if (!priceStr) priceStr = priceCell.innerText.split('‚ñ≤')[0].split('‚ñº')[0].trim();

                const maxPrice = parseInt(priceStr.replace(/[$, ]/g, '').trim());
                let deduction = parseFloat(input.value);
                if (isNaN(deduction) || deduction < 0) deduction = 0;
                if (deduction > 100) deduction = 100;

                if (!isNaN(maxPrice)) {
                    const rawFinal = maxPrice * (1 - deduction / 100);
                    const roundedFinal = customRound(rawFinal);
                    finalPriceInput.value = roundedFinal <= 0 ? '$0' : '$' + roundedFinal.toLocaleString();
                } else {
                    finalPriceInput.value = '-';
                }
            }

            inputs.forEach(input => {
                input.addEventListener('input', function () {
                    calculateRow(this);
                });
            });

            if (globalInput) {
                globalInput.addEventListener('input', function () {
                    const globalValue = this.value;
                    const deductionInputs = document.querySelectorAll('.deduction-input');
                    deductionInputs.forEach(input => {
                        input.value = globalValue;
                        calculateRow(input);
                    });
                });
            }
        }

        function loadBrandData(brand) {
            currentBrand = brand;
            const loading = document.getElementById('loading-indicator');
            const tbody = document.getElementById('data-table-body');
            const buttons = document.querySelectorAll('.brand-btn');

            // Êõ¥Êñ∞ÊåâÈàïÊ®£Âºè
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            loading.style.display = 'block';
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">ËºâÂÖ•‰∏≠...</td></tr>';

            fetch(`/api/get_brand_data/${brand}`)
                .then(res => res.json())
                .then(result => {
                    loading.style.display = 'none';
                    if (result.success) {
                        renderBrandData(result.data, brand);
                    } else {
                        tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: red;">ËºâÂÖ•Â§±Êïó: ${result.message}</td></tr>`;
                    }
                })
                .catch(err => {
                    loading.style.display = 'none';
                    tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: red;">ËºâÂÖ•ÈåØË™§: ${err.message}</td></tr>`;
                });
        }

        function renderBrandData(data, brand) {
            const tbody = document.getElementById('data-table-body');
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">ÁÑ°Ë≥áÊñô</td></tr>';
                return;
            }

            data.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'data-row';
                row.setAttribute('data-brand', brand);
                row.setAttribute('data-model', item.model);
                row.setAttribute('data-capacity', item.capacity);

                const defaultPrice = item.default_price || '-';

                row.innerHTML = `
                    <td>${brand}</td>
                    <td>${item.model}</td>
                    <td>${item.capacity}</td>
                    <td class="price" data-price="${item.max_price}">${item.max_price}</td>
                    <td>
                        <input type="number" min="0" max="100" class="deduction-input"
                            style="width: 60px; padding: 5px;" placeholder="%" autocomplete="off">
                    </td>
                    <td>
                        <input type="text" class="final-price-input" value="${defaultPrice}" autocomplete="off">
                    </td>
                    <td>
                        <button class="save-btn" onclick="savePrice(this)"
                            style="cursor: pointer; border: none; background: none; font-size: 1.2em;"
                            title="‰øùÂ≠òÂÉπÊ†º">üíæ</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            initializeCalculations();
        }

        function savePrice(btn) {
            const row = btn.closest('tr');
            const quoteNameInput = document.getElementById('quote-name');

            if (!quoteNameInput || !quoteNameInput.value.startsWith('Êñ∞Â¢û/')) {
                alert('Ë´ãÂÖàÂú®‰∏äÊñπËº∏ÂÖ•Ê°ÜËº∏ÂÖ• "Êñ∞Â¢û/Â†±ÂÉπÂñÆÂêçÁ®±" Êåá‰ª§ÔºÅ');
                return;
            }

            const clientName = quoteNameInput.value.substring(3).trim();
            const brand = row.getAttribute('data-brand');
            const model = row.getAttribute('data-model');
            const capacity = row.getAttribute('data-capacity');
            const finalPriceInput = row.querySelector('.final-price-input');
            const price = finalPriceInput.value;

            fetch('/update_single_price', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    client_name: clientName,
                    item: {
                        brand: brand,
                        model: model,
                        capacity: capacity,
                        price: price
                    }
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('ÂñÆÁ≠Ü‰øùÂ≠òÊàêÂäüÔºÅ');
                        const originalText = btn.innerText;
                        btn.innerText = '‚úÖ';
                        setTimeout(() => btn.innerText = originalText, 2000);
                    } else {
                        alert('‰øùÂ≠òÂ§±Êïó: ' + (data.message || 'Êú™Áü•ÈåØË™§'));
                    }
                });
        }

        function handleCommand() {
            const command = document.getElementById('quote-name').value.trim();
            if (!command) return;

            if (command === 'admintim') {
                // Fetch admin path from backend
                fetch('/get_admin_path')
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = `/${data.admin_path}`;
                        } else {
                            alert('Failed to get admin path: ' + (data.message || 'Unknown error'));
                        }
                    })
                    .catch(err => {
                        alert('Error: ' + err.message);
                    });
                return;
            }

            const rows = document.querySelectorAll('.data-row');
            const items = [];

            rows.forEach(row => {
                const finalPriceInput = row.querySelector('.final-price-input');
                const price = finalPriceInput.value;

                if (price && price !== '-') {
                    items.push({
                        brand: row.getAttribute('data-brand'),
                        model: row.getAttribute('data-model'),
                        capacity: row.getAttribute('data-capacity'),
                        price: price
                    });
                }
            });

            if (command.startsWith('Âà™Èô§/')) {
                const clientName = command.substring(3).trim();
                if (!confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§Â†±ÂÉπÂñÆ:${clientName} Âóé?Ê≠§Êìç‰Ωú‰∏çÂèØÈÄÜ!`)) return;

                fetch('/delete_quote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ client_name: clientName })
                })
                    .then(res => res.json())
                    .then(data => {
                        alert(data.message || 'Âà™Èô§Â§±Êïó');
                    });
                return;
            }

            if (command.startsWith('Êñ∞Â¢û/')) {
                const clientName = command.substring(3).trim();

                fetch('/generate_quote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_name: clientName,
                        items: items
                    }),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(`Â†±ÂÉπÂñÆ [${data.original_name}] Â∑≤Êõ¥Êñ∞!`);
                            window.open(data.link, '_blank');
                        } else {
                            alert('ÁîüÊàê/Êõ¥Êñ∞Â§±Êïó: ' + (data.message || 'Êú™Áü•ÈåØË™§'));
                        }
                    });
                return;
            }

            const clientName = command;
            fetch('/check_quote_exists', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: clientName })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.exists) {
                        alert(`Â†±ÂÉπÂñÆ [${clientName}] Â≠òÂú®!`);
                        window.open(data.link, '_blank');
                    } else {
                        alert(`Â†±ÂÉπÂñÆ [${clientName}] ‰∏çÂ≠òÂú®„ÄÇË´ã‰ΩøÁî® "Êñ∞Â¢û/${clientName}" Âª∫Á´ã„ÄÇ`);
                    }
                });
        }

        function generatePDF() {
            const dateDiv = document.getElementById('generation-date');
            const now = new Date();
            const dateStr = now.toLocaleDateString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });

            dateDiv.innerHTML = '<div class="generation-date-display">ÁîüÊàêÊó•ÊúüÔºö' + dateStr + '</div>';
            dateDiv.style.display = 'block';

            const element = document.querySelector('.container');
            const opt = {
                margin: 10,
                filename: 'Â†±ÂÉπÂñÆ_' + document.querySelector('h1').textContent + '_' + now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0') + '.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(function () {
                setTimeout(function () {
                    dateDiv.style.display = 'none';
                }, 1000);
            });
        }

        function shareToLine() {
            const currentUrl = window.location.href;
            const clientName = document.querySelector('h1').textContent;
            const message = clientName + '\n' + currentUrl;
            const lineUrl = 'https://line.me/R/msg/text/?' + encodeURIComponent(message);
            window.open(lineUrl, '_blank');
        }
    </script>
</body>

</html>